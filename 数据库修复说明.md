# MySQL数据库语法错误修复说明

## 问题原因
原始的`sql/init_database.sql`文件中存储过程语法有误。MySQL不支持在存储过程参数中直接使用`DEFAULT`关键字。

## 解决方案

### 方法1：使用修复版本（推荐）
```bash
# 使用修复版本的SQL文件
mysql -u analytics_user -p news_analytics < sql/init_database_fixed.sql
```

### 方法2：手动创建基础表结构
```bash
# 先创建数据库和用户
mysql -u root -p

# 在MySQL中执行以下命令
CREATE DATABASE IF NOT EXISTS news_analytics CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'analytics_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON news_analytics.* TO 'analytics_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# 然后只导入表结构（跳过存储过程）
mysql -u analytics_user -p news_analytics -e "
CREATE TABLE IF NOT EXISTS user_behavior_analytics (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    batch_id BIGINT NOT NULL,
    timestamp DATETIME NOT NULL,
    avg_click_rate DECIMAL(5,4) DEFAULT 0,
    active_users INT DEFAULT 0,
    total_impressions INT DEFAULT 0,
    total_clicks INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_batch_timestamp (batch_id, timestamp),
    INDEX idx_timestamp (timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS news_popularity_analytics (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    batch_id BIGINT NOT NULL,
    timestamp DATETIME NOT NULL,
    news_id VARCHAR(100) NOT NULL,
    clicks INT DEFAULT 0,
    impressions INT DEFAULT 0,
    ctr DECIMAL(5,4) DEFAULT 0,
    popularity_score DECIMAL(10,2) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_news_batch (news_id, batch_id),
    INDEX idx_news_id (news_id),
    INDEX idx_popularity_score (popularity_score DESC),
    INDEX idx_timestamp (timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS trending_analytics (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    batch_id BIGINT NOT NULL,
    timestamp DATETIME NOT NULL,
    news_id VARCHAR(100) NOT NULL,
    trend_score DECIMAL(10,2) DEFAULT 0,
    category VARCHAR(50),
    keywords TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_news_id (news_id),
    INDEX idx_trend_score (trend_score DESC),
    INDEX idx_timestamp (timestamp),
    INDEX idx_category (category)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS recommendation_results (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    batch_id BIGINT NOT NULL,
    timestamp DATETIME NOT NULL,
    user_id VARCHAR(100) NOT NULL,
    news_id VARCHAR(100) NOT NULL,
    rank_score DECIMAL(5,4) DEFAULT 0,
    recommendation_type VARCHAR(50) DEFAULT 'collaborative_filtering',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_news_id (news_id),
    INDEX idx_rank_score (rank_score DESC),
    INDEX idx_timestamp (timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS news_info (
    news_id VARCHAR(100) PRIMARY KEY,
    title TEXT,
    content LONGTEXT,
    category VARCHAR(50),
    subcategory VARCHAR(50),
    abstract TEXT,
    title_entities TEXT,
    created_time DATETIME,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_category (category),
    INDEX idx_created_time (created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
"
```

## 验证数据库创建
```bash
# 登录数据库验证表是否创建成功
mysql -u analytics_user -p news_analytics

# 在MySQL中查看表结构
SHOW TABLES;
DESCRIBE user_behavior_analytics;
DESCRIBE news_popularity_analytics;
DESCRIBE trending_analytics;
DESCRIBE recommendation_results;
DESCRIBE news_info;

# 退出
EXIT;
```

## 修复的主要内容

1. **存储过程参数语法修复**: 移除了`DEFAULT`关键字，在存储过程体内处理默认值
2. **添加安全检查**: 使用`DROP PROCEDURE IF EXISTS`避免重复创建错误
3. **优化JOIN查询**: 使用LEFT JOIN和COALESCE函数处理空值
4. **索引创建优化**: 添加`IF NOT EXISTS`检查

## 快速启动命令
```bash
# 1. 使用修复版本初始化数据库
mysql -u analytics_user -p news_analytics < sql/init_database_fixed.sql

# 2. 验证创建结果
mysql -u analytics_user -p news_analytics -e "SHOW TABLES;"

# 3. 继续项目启动流程
python3 utils/data_simulator.py --rate 3 --duration 10
```

现在你可以正常使用修复版本的SQL文件来初始化数据库了！ 